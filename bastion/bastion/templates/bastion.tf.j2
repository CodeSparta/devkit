provider "aws" {
  region	= var.aws_region
}

resource "aws_security_group" "bastion_sg" {
  name 		= var.bastion_security_group_name
  vpc_id        = var.vpc_id
  
  ingress {
    from_port	= 22
    to_port	= 22
    protocol	= "tcp"
    cidr_blocks	= ["0.0.0.0/0"]
  }

  egress {
    from_port	= 0
    to_port	= 0
    protocol	= "-1"
    cidr_blocks	= ["0.0.0.0/0"]
  }

  tags		= {
    Name	= var.bastion_security_group_name
  }
}

resource "aws_instance" "bastion" {
  ami		= var.bastion_ami_id
  instance_type	= var.bastion_instance_type
  associate_public_ip_address	= true
  subnet_id = var.bastion_subnet_id
  user_data = data.template_file.deploy.rendered
  
  tags		= {
    Name	= var.bastion_name
  }

  key_name			= var.bastion_public_ssh_key_name
  vpc_security_group_ids	= [aws_security_group.bastion_sg.id]
  
  root_block_device {
    delete_on_termination 	= true
    volume_size			= var.volume_size
    volume_type			= "standard"
  }
}

data "template_file" "deploy" {
  template = "${file("cloudinit.tpl")}" 
}

output "bastion_public_ip" {
  value = aws_instance.bastion.public_ip
}
